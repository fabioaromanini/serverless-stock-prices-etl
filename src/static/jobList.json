[
  {
    "name": "minMax",
    "destination": {
      "dataset": "daily_summaries_datamart",
      "table": "min_max"
    },
    "query": "SELECT\n  DATE('{{date}}') date,\n  (\n  SELECT\n    AS STRUCT symbol,\n    open\n  FROM\n    `etl-data-meetup.stock_dataset.deduplicated_stock_table`\n  WHERE\n    date = '{{date}}'\n  ORDER BY\n    tick,\n    open\n  LIMIT\n    1) lowest_open,\n  (\n  SELECT\n    AS STRUCT symbol,\n    open\n  FROM\n    `etl-data-meetup.stock_dataset.deduplicated_stock_table`\n  WHERE\n    date = '{{date}}'\n  ORDER BY\n    tick,\n    open DESC\n  LIMIT\n    1) highest_open,\n      (\n  SELECT\n    AS STRUCT symbol,\n    close\n  FROM\n    `etl-data-meetup.stock_dataset.deduplicated_stock_table`\n  WHERE\n    date = '{{date}}'\n  ORDER BY\n    tick DESC,\n    close\n  LIMIT\n    1) lowest_close,\n    (\n  SELECT\n    AS STRUCT symbol,\n    close\n  FROM\n    `etl-data-meetup.stock_dataset.deduplicated_stock_table`\n  WHERE\n    date = '{{date}}'\n  ORDER BY\n    tick DESC,\n    close DESC\n  LIMIT\n    1) highest_close,\n    (\n  SELECT\n    AS STRUCT symbol,\n    high,\n    tick\n  FROM\n    `etl-data-meetup.stock_dataset.deduplicated_stock_table`\n  WHERE\n    date = '{{date}}'\n  ORDER BY\n    high DESC\n  LIMIT\n    1) highest_overall,\n    (\n  SELECT\n    AS STRUCT symbol,\n    low,\n    tick\n  FROM\n    `etl-data-meetup.stock_dataset.deduplicated_stock_table`\n  WHERE\n    date = '{{date}}'\n  ORDER BY\n    low\n  LIMIT\n    1) lowest_overall"
  },
  {
    "name": "repeatedStockData",
    "destination": {
      "dataset": "daily_summaries_datamart",
      "table": "repeated_stock_data"
    },
    "query": "SELECT\n  DISTINCT DATE('{{date}}') date,\n  repetitions,\n  symbol\nFROM (\n  SELECT\n    COUNT(tick) repetitions,\n    symbol,\n    tick\n  FROM\n    `etl-data-meetup.stock_dataset.stock_table`\n  WHERE\n    date = '{{date}}'\n  GROUP BY\n    symbol,\n    tick\n  HAVING\n    repetitions > 1 )"
  },
  {
    "name": "greatestVariation",
    "destination": {
      "dataset": "daily_summaries_datamart",
      "table": "greatest_variation"
    },
    "query": "WITH\n  ranked_min AS (\n  SELECT\n    RANK() OVER (PARTITION BY symbol ORDER BY open, tick) rank,\n    open,\n    tick min_tick,\n    symbol\n  FROM\n    `etl-data-meetup.stock_dataset.deduplicated_stock_table`\n  WHERE\n    date = '{{date}}' ),\n  min AS (\n  SELECT\n    *\n  FROM\n    ranked_min\n  WHERE\n    rank = 1 ),\n  ranked_max AS (\n  SELECT\n    RANK() OVER (PARTITION BY symbol ORDER BY close DESC, tick DESC) rank,\n    close,\n    tick max_tick,\n    symbol\n  FROM\n    `etl-data-meetup.stock_dataset.deduplicated_stock_table`\n  WHERE\n    date = '{{date}}'),\n  max AS (\n  SELECT\n    *\n  FROM\n    ranked_max\n  WHERE\n    rank = 1),\n  joined AS (\n  SELECT\n    symbol,\n    open,\n    min_tick,\n    close,\n    max_tick\n  FROM\n    min\n  JOIN\n    max\n  USING\n    (symbol))\nSELECT\n  DATE('{{date}}') date,\n  *,\nIF\n  (max_tick < min_tick,\n    'DECRESCENT',\n    'CRESCENT') sense,\n  ABS(close - open) magnitude\nFROM\n  joined"
  }
]
